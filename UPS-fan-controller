esphome:
  name: ups-fan-controller
  friendly_name: UPS-fan-controller
  project:
    name: carrot8848.ups-fan-controller
    version: "1.0.0"
esp32:
  board: esp32-c3-devkitm-1
  framework:
    type: arduino

# Enable logging
logger:

# Enable Home Assistant API
api:

ota:
wifi:
  ap:
captive_portal:
web_server:
  port: 80
spi:
  miso_pin: 1
  mosi_pin: 5
  clk_pin: 4
output:
  - platform: ledc
    pin: GPIO8
    id: Fan0_output
    frequency: 15000
    # min_power: 0.15
    inverted: True
    zero_means_zero: True

  - platform: ledc
    pin: GPIO3
    id: Fan1_output
    frequency: 1000
    # min_power: 0.15
    inverted: True
    zero_means_zero: True

  - platform: ledc
    pin: GPIO18
    id: Fan2_output
    frequency: 5000
    # min_power: 0.15
    inverted: True
    zero_means_zero: True
fan:
  - platform: speed
    id: fan0
    output: Fan0_output
    name: "Fan0"
  - platform: speed
    output: Fan1_output
    name: "Fan1"
  - platform: speed
    output: Fan2_output
    name: "Fan2"
sensor:
  - platform: pulse_counter
    pin: 7
    name: "Fan0 Speed"
    unit_of_measurement: 'RPM'
    filters:
      - multiply: 0.5
      # - lambda: |-
      #     if (x <= 1500) return x;
      #     else return {};
    count_mode:
      rising_edge: INCREMENT
      falling_edge: DISABLE
    update_interval: 5s

  - platform: pulse_counter
    pin: 19
    name: "Fan2 Speed"
    unit_of_measurement: 'RPM'
    filters:
      - multiply: 0.5
      # - lambda: |-
      #     if (x <= 1500) return x;
      #     else return {};
    count_mode:
      rising_edge: INCREMENT
      falling_edge: DISABLE
    update_interval: 5s

  - platform: max31865
    id: temp
    update_interval: 10s
    name: "PT100 Temperature"
    cs_pin: 10
    reference_resistance: 430 Ω
    rtd_nominal_resistance: 100 Ω
    mains_filter: 50Hz
    rtd_wires: 4
  # - platform: rotary_encoder
  #   name: "fan_speed Encoder"
  #   pin_a: 0
  #   pin_b: 1
status_led:
  pin: 
    number: GPIO6
    inverted: True

climate:
  - platform: pid
    name: "UPS Temperature Controller"
    sensor: temp
    default_target_temperature: 40°C
    cool_output: Fan0_output
    control_parameters:
      kp: 0.49460
      ki: 0.00487
      kd: 12.56301
      output_averaging_samples: 5      # smooth the output over 5 samples
      derivative_averaging_samples: 5  # smooth the derivative value over 10 samples
    deadband_parameters:
      threshold_high: 1°C       # deadband within +/-0.5°C of target_temperature
      threshold_low: -100°C
